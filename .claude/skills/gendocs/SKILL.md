---
name: gendocs
description: 아무 소스(파일, 텍스트, 구두 설명)로부터 비즈니스 문서(DOCX 등)를 생성하는 가이드 플로우
argument-hint: "[파일 경로 또는 설명]"
allowed-tools: Bash, Read, Write, Edit, Glob, Grep, AskUserQuestion
---

# gendocs 문서 생성 플로우

이 스킬은 대화형으로 문서를 생성하는 가이드 플로우를 실행합니다.
아래 단계를 순서대로 진행하세요. 각 단계에서 AskUserQuestion으로 사용자 선택을 받습니다.

$ARGUMENTS 가 있으면:
- `.md` 파일이면 해당 파일을 원본으로 사용하고 2단계를 건너뛰세요.
- 다른 파일 확장자(`.docx`, `.pdf`, `.txt`, `.xlsx`, `.hwp` 등)면 2단계의 "기존 파일 변환"으로 진행하세요.
- 파일 경로가 아닌 텍스트면 문서 주제 설명으로 간주하고 2단계의 "구두 설명"으로 진행하세요.

---

## 1단계: 출력 포맷 선택

AskUserQuestion으로 물어보세요:

| 선택지 | 설명 |
|--------|------|
| Word (.docx) | API 명세서, 요건 정의서, 기술 문서 (검증 완료) |
| Excel (.xlsx) | 데이터 명세, 코드 정의서 (예정) |
| PowerPoint (.pptx) | 제안서, 발표 자료 (예정) |
| PDF (.pdf) | 최종 배포용 (예정) |

> 현재 Word(.docx)만 검증 완료 상태입니다. 다른 포맷 선택 시 "아직 지원되지 않는 포맷입니다. DOCX를 먼저 생성하시겠습니까?" 로 안내하세요.

---

## 2단계: 소스 입력

**AskUserQuestion으로 물어보세요: "어떤 소스를 가지고 계신가요?"**

| 선택지 | 설명 |
|--------|------|
| 기존 파일 변환 | 가지고 있는 파일(Word, PDF, 텍스트, 엑셀 등)을 깔끔한 문서로 재작성 |
| 텍스트 붙여넣기 | 대화창에 내용을 직접 붙여넣기 |
| 구두 설명 | 만들고 싶은 문서를 설명하면 Claude Code가 작성 |
| source/ 폴더의 MD 파일 | 이미 준비된 마크다운 파일 사용 |

각 선택지별 처리:

### A. 기존 파일 변환

1. 사용자에게 파일 경로를 물어보세요.
2. 파일 포맷에 따라 내용을 추출하세요:
   - `.docx` → `python -X utf8 tools/extract-docx.py <파일> --json [--extract-images <dir>]` 실행 (ZIP+XML 방식, 의존성 없음). 제목/테이블/코드블록/인포박스/이미지를 구조화된 JSON으로 추출합니다. 이미지가 있으면 `--extract-images`로 함께 추출합니다.
   - `.pdf` → Read 도구로 내용 추출. 아래 **PDF 구조화 규칙**을 반드시 따르세요.
   - `.txt` / `.csv` / `.json` / `.yaml` → Read 도구로 텍스트 직접 읽기.
   - `.xlsx` → Read 도구로 읽기 (시트 내용 추출).
   - `.hwp` → 읽기 불가 시 사용자에게 텍스트로 붙여넣기를 안내하세요.
3. 추출된 내용을 분석하여 **문서 구조를 파악**하세요:
   - 제목 계층 (heading level)
   - 테이블 헤더 패턴 (doc-config tableWidths에 활용)
   - 코드블록 (dark/light), 인포박스, 경고박스
4. gendocs 마크다운 규칙에 맞춰 `source/` 에 MD 파일을 자동 생성하세요.
5. 생성된 MD를 사용자에게 간략히 보고: "N개 섹션, M개 테이블로 구성된 MD를 생성했습니다."
6. **원본 소스 카운트를 기록**하세요 (섹션 수, 테이블 수, 코드블록 수, 이미지 수 등). 5단계 콘텐츠 검증에서 사용합니다.
7. 3단계로 진행.

#### PDF 구조화 규칙

PDF는 DOCX와 달리 heading level, 테이블 구조 등의 메타데이터가 없으므로 내용을 추론하여 구조화합니다. **converter가 지원하는 요소만** 사용하세요:

**지원 요소**: H2, H3, H4, 불릿(`-`), 테이블, 코드블록, 인포박스(`> 참고:`), 경고박스(`> 주의:`), 이미지, 본문 텍스트

**금지**: 중첩 불릿 리스트 (converter가 들여쓰기를 무시하므로 구조가 손실됨)

**구조 변환 원칙**:
- 중첩 리스트(3단계 이상, 다차원 구조) → **테이블**로 변환
- 단순 키-값 1~3개 → `- **키** — 값` 형식의 불릿 사용 (소규모 2컬럼 테이블 남용 금지)
- 코드, 명령어, 설정 값은 코드블록(` ``` `)으로 감싸기
- 주의/참고 사항은 인용문(`> 주의:`, `> 참고:`)으로 표현

**heading level 판단**:
- PDF에서 가장 큰 제목 → H2 (H1은 문서 제목 1개만)
- 그 아래 소제목 → H3
- 그 아래 세부 항목 → H4
- 볼드 텍스트가 독립 줄에 있으면 heading 후보

### B. 텍스트 붙여넣기

1. 사용자에게 내용을 붙여넣어 달라고 안내하세요.
2. 붙여넣어진 텍스트를 분석하여 구조화하세요:
   - 줄바꿈, 들여쓰기, 구분자 패턴으로 섹션 분리
   - 탭/콤마 구분 데이터는 테이블로 변환
   - 코드 패턴 감지 시 코드블록으로 감싸기
3. gendocs MD 형식으로 `source/` 에 저장.
4. 셀프리뷰 단계로 진행.

### C. 구두 설명

1. 사용자에게 물어보세요:
   - "어떤 종류의 문서인가요?" (API 명세서, 요건 정의서, 제안서, 가이드 등)
   - "어떤 내용을 포함해야 하나요?" (섹션, 주요 항목)
   - "특별히 포함할 데이터가 있나요?" (테이블, 코드 예시 등)
2. 사용자 답변을 기반으로 MD를 작성하여 `source/`에 저장.
3. 셀프리뷰 단계로 진행.

### D. source/ 폴더의 MD 파일

1. source/ 폴더를 조회하여 기존 MD 파일 목록을 AskUserQuestion으로 보여주세요.
2. 사용자가 파일을 선택하면 셀프리뷰 단계로 진행.

---

### MD 생성 규칙

기존 파일 변환, 텍스트 붙여넣기, 구두 설명 모두 최종적으로 MD를 생성합니다.
생성되는 MD는 다음 구조를 따르세요:

```markdown
# 문서 제목

> **프로젝트**: ...
> **버전**: v1.0
> **작성일**: YYYY-MM-DD

---

## 목차

- [변경 이력](#변경-이력)
- [1. 섹션명](#1-섹션명)
- ...

---

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| v1.0 | YYYY-MM-DD | 작성자 | 초안 작성 |

> **변경 이력 작성 규칙**: v1.0 이전 버전(v0.8, v0.9 등)이 존재하면 v1.0의 변경 내용은 "초안 작성"이 아닌 "정식 릴리스" 또는 "전체 문서 통합"으로 표기하세요. "초안 작성"은 변경 이력이 1건뿐일 때만 사용합니다.

---

## 1. 섹션명

### 1.1 소제목

본문 내용...

| 헤더1 | 헤더2 | 헤더3 |
|-------|-------|-------|
| 값1 | 값2 | 값3 |
```

핵심 규칙:
- H1은 문서 제목 (1개만)
- H2는 대분류 섹션 (`## 변경 이력`, `## 1. 개요`, ...)
- H3는 소분류 (`### 1.1 목적`)
- 테이블은 마크다운 표준 문법
- 인용문: `> 주의:` → 경고 박스, `> 참고:` / `> 중요:` → 정보 박스
- 코드블록: ` ```언어 ` 형식
- 이미지: `![설명](경로)`
- 흐름도: `**Step 1**: 설명` 형식

---

## 셀프리뷰 (필수 게이트 — 생략 금지)

**MD를 생성하거나 선택한 후, 이 단계를 완료하기 전에 3단계로 진행하지 마세요.**

2단계에서 MD가 준비되면(생성, 변환, 선택 모두 해당), 반드시 아래 셀프리뷰를 수행합니다:

1. **읽는 사람 관점으로 MD를 처음부터 끝까지 읽기**
   - 섹션 구조가 논리적인가? (목차 → 변경 이력 → 본문 순서)
   - 각 요소의 표현 방식이 적절한가?
     - 소규모 키-값(1~3행 2컬럼)은 테이블 대신 불릿이 자연스러운지
     - 긴 설명문은 테이블 안에 억지로 넣지 않았는지
     - 코드블록의 언어 태그가 올바른지
   - 누락된 섹션이나 불완전한 내용이 없는지

2. **어색한 부분 수정** → source/ MD 파일 직접 편집

3. **반복 패턴 여부 판단**
   - 발견한 문제가 이 문서만의 문제가 아니라 반복될 패턴이면, 원인이 된 규칙(SKILL.md, MEMORY.md 등)도 함께 수정
   - 규칙 수정 시: `node tools/regression-test.js`를 실행하여 기존 문서가 깨지지 않는지 확인

4. **배치(batch) 처리 시에도 예외 없음**
   - 여러 문서를 한 번에 처리하더라도, 각 MD에 대해 셀프리뷰를 수행
   - 시간 제약 시 최소한 샘플 3~5개를 대표로 검토

> 셀프리뷰 완료 후 3단계로 진행합니다.

---

## 3단계: 템플릿 선택

AskUserQuestion으로 물어보세요:

| 선택지 | 설명 |
|--------|------|
| Professional (권장) | 가로 레이아웃, 다크테마 코드블록, 표지, 머릿글/바닥글 |
| Basic | 세로 레이아웃, 심플 스타일 |

---

## 4단계: 문서 정보 입력

AskUserQuestion으로 물어보세요:

- **문서 제목**: 기본값은 MD 파일의 H1 제목
- **부제목**: 선택사항
- **버전**: 기본값 v1.0
- **작성자/회사**: 선택사항

> 사용자가 "기본값으로" 또는 "그냥 진행해"라고 하면 MD에서 추출한 기본값으로 진행하세요.

---

## 자가개선 3계층

문서 생성 과정에서 3단계의 자가개선이 동작합니다.

| 계층 | 시점 | 무엇을 | 어떻게 |
|------|------|--------|--------|
| ① MD 셀프리뷰 | 변환 전 | MD 표현 적절성 | 읽는 사람 관점 재검토 + 반복 패턴이면 프로젝트 규칙도 수정 |
| ② 콘텐츠 검증 | 변환 후 | 원본 대비 누락 | 요소 수 비교 (섹션/테이블/코드/이미지) |
| ③ 레이아웃 루프 | 변환 후 | 페이지 배치 | WARN 기반 doc-config 수정 반복 (최대 4회) |

- 계층 ①: 2단계 후 **필수 게이트** → [셀프리뷰](#셀프리뷰-필수-게이트--생략-금지)
- 계층 ②: 5단계 변환 후 실행 → [5-4. 콘텐츠 검증](#5-4-계층--콘텐츠-검증-원본-대비)
- 계층 ③: 6단계에서 실행 → [6단계. 레이아웃 자가개선 루프](#6단계-계층--레이아웃-자가개선-루프-최대-4회)

---

## 5단계: doc-config 생성 + 변환 실행

이 단계는 자동으로 진행합니다. 사용자에게 진행 상황을 알려주세요.

### 5-1. doc-config JSON 작성

기존 doc-configs/ 에서 유사한 설정 파일을 참조하여 `doc-configs/{파일명}.json`을 작성하세요.

참조할 것:
- `examples/sample-api/doc-config.json` — API 명세서 패턴 (테이블, JSON 코드블록, 정보/경고 박스)
- `examples/sample-batch/doc-config.json` — 배치 규격서 패턴 (고정길이 레코드, 명시적 break 목록)
- `lib/converter-core.js` — config JSON 스키마 및 변환 로직

doc-config JSON에 포함할 내용:
```json
{
  "source": "source/파일명.md",
  "output": "output/파일명_{version}.docx",
  "template": "professional",
  "h1CleanPattern": "^# 문서제목패턴",
  "headerCleanUntil": "## 변경 이력",
  "docInfo": { "title": "...", "subtitle": "...", "version": "v1.0", ... },
  "tableWidths": { "헤더1|헤더2|헤더3": [w1, w2, w3], ... },
  "pageBreaks": { ... },
  "images": { "basePath": "...", "sectionMap": { ... } }
}
```

### 5-2. 실행
```bash
node lib/convert.js doc-configs/{파일명}.json
```

### 5-3. 레이아웃 검증 (JSON 리포트)
```bash
python -X utf8 tools/validate-docx.py output/{파일명}.docx --json
```

또는 한 번에 실행+검증:
```bash
node lib/convert.js doc-configs/{파일명}.json --validate
```

### 5-4. 계층 ② — 콘텐츠 검증 (원본 대비)

**모든 입력 타입에 대해** 생성된 DOCX의 구조가 원본 소스와 일치하는지 확인하세요.

검증 항목:
- 섹션(heading) 수: 원본과 생성물의 H2/H3/H4 수가 일치하는지
- 테이블 수: 원본의 테이블이 모두 포함되었는지
- 코드블록 수: 원본의 코드/명령어가 모두 포함되었는지
- 이미지 수: 원본의 이미지가 모두 포함되었는지

비교 방법 (입력 타입별):
- `.docx` 입력 → extract-docx.py의 stats와 validate-docx.py의 stats 비교
- `.pdf` 입력 → 2단계에서 기록한 원본 카운트와 validate stats 비교
- 텍스트/구두 → 생성된 MD의 구조와 validate stats 비교

불일치 시:
- 누락된 항목을 식별하고 source MD 또는 doc-config를 수정
- 수정 후 5-2부터 재실행

### 5-5. 결과 리포트
검증 결과를 사용자에게 보고하세요:
- 추정 페이지 수
- WARN/INFO 건수
- 주요 이슈 내용
- 콘텐츠 검증 결과 (원본 대비 일치 여부)

---

## 6단계: 계층 ③ — 레이아웃 자가개선 루프 (최대 4회)

검증 결과에 따라 판정하세요:

| 판정 | 조건 | 행동 |
|------|------|------|
| **PASS** | WARN 0건 | 루프 종료, 완료 안내 |
| **FIX** | WARN 있음 | doc-config 수정 → 재실행 → 재검증 |
| **SKIP** | INFO만 있음 | 루프 종료 (INFO는 참고용) |
| **ROLLBACK** | 수정 후 페이지 수 10%↑ | 수정 취소, 사용자 확인 |

### FIX 시 수정 대상
- **WARN만 자동 수정** (이미지 배치 등 명확한 문제)
- **INFO는 수정하지 않음** (고아 제목 등은 시뮬레이션 추정치이므로 실제 Word 렌더링과 다를 수 있음)
- 수정: doc-config JSON의 `pageBreaks`, `tableWidths` 등을 조정
- 일괄 패턴 매칭으로 break를 넣지 말 것 (특정 위치만 수정)

### ROLLBACK 판정
- 수정 전 페이지 수를 기록
- 수정 후 페이지 수가 10% 이상 증가하면 과도한 수정
- 수정을 되돌리고 사용자에게 에스컬레이션

### 4회 초과 시
- 자동 수정을 중단하고 사용자에게 보고
- 남은 WARN을 나열하고 AskUserQuestion으로 선택받기:

| 선택지 | 설명 |
|--------|------|
| 이대로 완료 | 현재 결과물을 최종으로 확정 |
| 직접 피드백 | 사용자가 추가 수정사항을 직접 지시 |

"직접 피드백"을 선택한 경우:
- 사용자의 피드백을 듣고 doc-config 또는 source MD를 수정
- 5단계를 다시 진행

---

## 완료

최종 산출물 경로를 안내하세요:
```
output/{파일명}.docx 생성 완료
```

변환이 성공(WARN 0)하면 패턴 DB를 갱신하세요:
```bash
node tools/extract-patterns.js
```

재실행 방법도 알려주세요:
```
재실행: node lib/convert.js doc-configs/{파일명}.json
검증:   node lib/convert.js doc-configs/{파일명}.json --validate
재검증: python -X utf8 tools/validate-docx.py output/{파일명}.docx
회귀:   node tools/regression-test.js
```
