# 주문처리 배치 연동 규격서

> **프로젝트**: OrderHub 배치 연동 시스템
> **버전**: v1.0
> **작성일**: 2026-02-01
> **수신**: 파트너사
> **발신**: OrderHub

---

## 목차

- [1. 개요](#1-개요)
- [2. 통신 방식](#2-통신-방식)
- [3. 배치 파일 규격](#3-배치-파일-규격)
- [4. 결과코드](#4-결과코드)
- [5. 처리 요건](#5-처리-요건)
- [6. 파일 검증 규칙](#6-파일-검증-규칙)
- [7. 연동 테스트 체크리스트](#7-연동-테스트-체크리스트)

---

## 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v1.0 | 2026-02-01 | - | 초안 작성 |

---

## 1. 개요

### 1.1 목적

본 문서는 파트너사와 OrderHub 간 **주문처리 배치 파일 연동** 규격을 정의합니다. 파트너사에서 주문 요청 파일을 SFTP로 전송하면, OrderHub가 주문 접수·결제·재고 확인을 처리한 후 결과 파일을 회신합니다.

> 참고: 본 규격서는 B2B 대량 주문 배치 연동 전용이며, 실시간 단건 주문은 별도 API 규격서를 참조하십시오.

### 1.2 처리 구분

| 구분 | 조건 | 처리 방식 |
|------|------|----------|
| **당일 처리** | 주문요청일자 = 파일 수신 당일 | 실시간 건별 주문 접수 + 결제 |
| **익일 처리** | 주문요청일자 > 파일 수신 당일 | 익영업일 배치 일괄 접수 |

> 주의: 주문요청일자가 파일 수신일보다 과거인 경우 해당 건은 **반려**(결과코드 8201) 처리됩니다.

### 1.3 연동 흐름

```
[파트너사]                    [OrderHub SFTP]              [OrderHub]
    │                        /batch/partner/                   │
    │  ① 요청 파일 업로드       │                               │
    │ ─────────────────────→ │  /request/                     │
    │                        │ ─── 폴링 감지 ───────────────→ │
    │                        │                     당일건 → 실시간 접수
    │                        │                     익일건 → 배치 접수
    │                        │                     ↓
    │                        │                  결제 처리 + 재고 확인
    │                        │                               │
    │                        │  /response/  ←── 결과 파일 ─── │
    │  ② 결과 파일 다운로드     │                               │
    │ ←───────────────────── │                               │
```

---

## 2. 통신 방식

### 2.1 SFTP 접속 정보

> 참고: 전용선(VPN) 경유. 파트너사 출발지 IP 사전 등록이 필요합니다.

| 항목 | 운영 | 테스트 |
|------|------|--------|
| **IP** | 10.200.50.10 | 10.100.50.10 |
| **Port** | 22 | 22 |
| **Protocol** | SFTP (SSH2) | SFTP (SSH2) |
| **인증 방식** | 공개키 + Password | Password |
| **계정** | OrderHub에서 ID/PW 발급 | OrderHub에서 ID/PW 발급 |
| **타임아웃** | 연결 30초, 전송 300초 | 연결 30초, 전송 300초 |

### 2.2 디렉토리 구조

```
/batch/partner/
├── request/          ← 당일 요청 파일 (파트너사 업로드)
│   └── YYYYMM/      ← 전일 이전 파일 자동 이동 (아카이브)
├── response/         ← 당일 응답 파일 (OrderHub 생성)
│   └── YYYYMM/      ← 전일 이전 파일 자동 이동 (아카이브)
└── error/            ← 파싱 실패 파일 격리 (OrderHub 관리)
```

### 2.3 파일 전송 흐름

| 단계 | 주체 | 동작 |
|:----:|------|------|
| 1 | **파트너사** | OrderHub SFTP 접속 → `/request/`에 요청 파일 업로드 |
| 2 | **파트너사** | 업로드 완료 후 `.done` 트리거 파일 생성 |
| 3 | **OrderHub** | `/request/` 폴링 → `.done` 감지 시 파일 수신 처리 |
| 4 | **OrderHub** | 파일 파싱 → 당일건 실시간 처리 / 익일건 배치 큐 등록 |
| 5 | **OrderHub** | `/response/`에 처리결과 파일 생성 |
| 6 | **파트너사** | OrderHub SFTP 접속 → `/response/`에서 결과 파일 다운로드 |

> 주의: `.done` 트리거 파일이 없으면 OrderHub는 해당 요청 파일을 처리하지 않습니다. 업로드 도중 파일이 감지되는 것을 방지하기 위한 안전장치입니다.

---

## 3. 배치 파일 규격

### 3.1 공통 규칙

| 항목 | 규격 |
|------|------|
| **레코드 구조** | S(Summary) / D(Detail) / E(End) |
| **필드 방식** | 고정길이 (Fixed-length) |
| **인코딩** | UTF-8 (BOM 없음) |
| **레코드 종료** | CRLF (\r\n) |
| **숫자(N) 필드** | 우측정렬, 좌측 0패딩 (음수 불허) |
| **문자(AN) 필드** | 좌측정렬, 우측 공백패딩 |
| **금액 단위** | 원 (소수점 없음) |
| **레코드 길이** | 요청 200byte / 응답 250byte (Filler 포함) |

### 3.2 파일 명명 규칙

| 구분 | 패턴 | 방향 |
|------|------|------|
| **요청** | ODREQ_YYYYMMDD_NNN.dat | 파트너사 → OrderHub |
| **응답** | ODRES_YYYYMMDD_NNN.dat | OrderHub → 파트너사 |
| **트리거** | ODREQ_YYYYMMDD_NNN.done | 파트너사 생성 (0byte) |

- `YYYYMMDD`: 파일 생성일자
- `NNN`: 일련번호 (001~999, 일자별 리셋)

---

### 3.3 요청 파일 (파트너사 → OrderHub)

> 전문코드: OD11 (주문 배치 요청)

#### S 레코드 (Summary) — 1건

| No | 필드명 | 타입 | 길이 | 시작 | 필수 | 설명 |
|:--:|--------|:----:|:----:|:----:|:----:|------|
| 1 | 레코드구분 | AN | 1 | 1 | Y | S |
| 2 | 전문코드 | AN | 4 | 2 | Y | OD11 |
| 3 | 파일생성일자 | N | 8 | 6 | Y | YYYYMMDD |
| 4 | 파일일련번호 | N | 3 | 14 | Y | 001~ |
| 5 | 파트너코드 | AN | 10 | 17 | Y | OrderHub 발급 파트너 식별코드 |
| 6 | 총건수 | N | 7 | 27 | Y | D레코드 건수 |
| 7 | 총주문금액 | N | 15 | 34 | Y | D레코드 주문금액 합계 |
| 8 | 총배송비 | N | 15 | 49 | Y | D레코드 배송비 합계 |
| 9 | Filler | AN | 137 | 64 | - | 공백 |

#### D 레코드 (Detail) — N건

| No | 필드명 | 타입 | 길이 | 시작 | 필수 | 설명 |
|:--:|--------|:----:|:----:|:----:|:----:|------|
| 1 | 레코드구분 | AN | 1 | 1 | Y | D |
| 2 | 순번 | N | 7 | 2 | Y | 0000001~ |
| 3 | 주문요청일자 | N | 8 | 9 | Y | YYYYMMDD (당일/익일 판별 기준) |
| 4 | 주문번호 | AN | 20 | 17 | Y | 파트너사 측 주문 식별자 |
| 5 | 상품코드 | AN | 15 | 37 | Y | OrderHub 상품코드 |
| 6 | 수량 | N | 5 | 52 | Y | 주문 수량 |
| 7 | 단가 | N | 13 | 57 | Y | 상품 단가 (원) |
| 8 | 주문금액 | N | 13 | 70 | Y | 수량 × 단가 |
| 9 | 할인금액 | N | 13 | 83 | N | 할인 적용 금액 (0 패딩) |
| 10 | 결제금액 | N | 13 | 96 | Y | 주문금액 - 할인금액 |
| 11 | 배송비 | N | 9 | 109 | Y | 배송비 (면제 시 000000000) |
| 12 | 수수료 | N | 9 | 118 | N | 파트너 수수료 (정산용) |
| 13 | 수령인명 | AN | 20 | 127 | Y | 배송 수령인 |
| 14 | 수령인연락처 | AN | 15 | 147 | Y | 01012345678 형식 |
| 15 | 배송우편번호 | AN | 5 | 162 | Y | 5자리 우편번호 |
| 16 | 배송주소 | AN | 30 | 167 | Y | 배송 주소 (시/군/구까지) |
| 17 | Filler | AN | 4 | 197 | - | 공백 |

#### E 레코드 (End) — 1건

| No | 필드명 | 타입 | 길이 | 시작 | 필수 | 설명 |
|:--:|--------|:----:|:----:|:----:|:----:|------|
| 1 | 레코드구분 | AN | 1 | 1 | Y | E |
| 2 | 전문코드 | AN | 4 | 2 | Y | OD11 |
| 3 | 총건수 | N | 7 | 6 | Y | S레코드와 일치 검증 |
| 4 | 총주문금액 | N | 15 | 13 | Y | S레코드와 일치 검증 |
| 5 | 총배송비 | N | 15 | 28 | Y | S레코드와 일치 검증 |
| 6 | Filler | AN | 157 | 43 | - | 공백 |

#### 요청 파일 예시

> 파일명: ODREQ_20260201_001.dat / 당일건 2건 + 익일건 1건 = 총 3건

**필드 분리 예시 (가독성용):**

```
[S] OD11 | 20260201 | 001 | PTN0001    | 건수:0000003 | 주문금액:000000000235000 | 배송비:000000000009000
[D] 순번:0000001 | 20260201 | ORD-2026020100001    | PRD-A00001      | 수량:00002 | 단가:0000000045000 | 주문:0000000090000 | 할인:0000000005000 | 결제:0000000085000 | 배송:000003000 | 수수료:000002550 | 홍길동     | 01012345678 | 06134 | 서울시 강남구 테헤란로
[D] 순번:0000002 | 20260201 | ORD-2026020100002    | PRD-B00023      | 수량:00001 | 단가:0000000120000 | 주문:0000000120000 | 할인:0000000000000 | 결제:0000000120000 | 배송:000003000 | 수수료:000003600 | 김영희     | 01098765432 | 13494 | 경기도 성남시 분당구
[D] 순번:0000003 | 20260202 | ORD-2026020100003    | PRD-C00105      | 수량:00001 | 단가:0000000025000 | 주문:0000000025000 | 할인:0000000000000 | 결제:0000000025000 | 배송:000003000 | 수수료:000000750 | 박철수     | 01055556666 | 48058 | 부산시 해운대구 우동
[E] OD11 | 건수:0000003 | 주문금액:000000000235000 | 배송비:000000000009000
```

---

### 3.4 응답 파일 (OrderHub → 파트너사)

> 전문코드: OD12 (주문 배치 결과)

#### S 레코드 (Summary) — 1건

| No | 필드명 | 타입 | 길이 | 시작 | 필수 | 설명 |
|:--:|--------|:----:|:----:|:----:|:----:|------|
| 1 | 레코드구분 | AN | 1 | 1 | Y | S |
| 2 | 전문코드 | AN | 4 | 2 | Y | OD12 |
| 3 | 파일생성일자 | N | 8 | 6 | Y | YYYYMMDD |
| 4 | 파일일련번호 | N | 3 | 14 | Y | 요청과 동일 번호 |
| 5 | 파트너코드 | AN | 10 | 17 | Y | 에코백 |
| 6 | 총건수 | N | 7 | 27 | Y | D레코드 건수 |
| 7 | 총주문금액 | N | 15 | 34 | Y | 요청 총주문금액 |
| 8 | 파일결과코드 | AN | 4 | 49 | Y | 0000=정상, 반려 시 사유코드 (4.2 참조) |
| 9 | 성공건수 | N | 7 | 53 | Y | 성공 처리된 D레코드 건수 |
| 10 | 성공금액 | N | 15 | 60 | Y | 성공 처리된 결제금액 합계 |
| 11 | 실패건수 | N | 7 | 75 | Y | 실패 처리된 D레코드 건수 |
| 12 | 실패금액 | N | 15 | 82 | Y | 실패 처리된 결제금액 합계 |
| 13 | Filler | AN | 153 | 97 | - | 공백 |

#### D 레코드 (Detail) — N건

| No | 필드명 | 타입 | 길이 | 시작 | 필수 | 설명 |
|:--:|--------|:----:|:----:|:----:|:----:|------|
| 1 | 레코드구분 | AN | 1 | 1 | Y | D |
| 2 | 순번 | N | 7 | 2 | Y | 요청과 동일 순번 |
| 3 | 주문요청일자 | N | 8 | 9 | Y | 에코백 |
| 4 | 주문번호 | AN | 20 | 17 | Y | 에코백 |
| 5 | 상품코드 | AN | 15 | 37 | Y | 에코백 |
| 6 | 결제금액 | N | 13 | 52 | Y | 에코백 |
| 7 | 처리결과 | AN | 1 | 65 | Y | Y=성공, N=실패 |
| 8 | 결과코드 | AN | 4 | 66 | Y | 0000=성공 (4.1 참조) |
| 9 | 처리일시 | N | 14 | 70 | Y | YYYYMMDDHHmmss |
| 10 | OrderHub주문번호 | AN | 20 | 84 | Y | OrderHub 발번 (성공 시) |
| 11 | 배송추적번호 | AN | 20 | 104 | N | 택배사 운송장번호 (출고 후 기록) |
| 12 | 예상출고일자 | N | 8 | 124 | N | YYYYMMDD (성공 시) |
| 13 | 정산예정금액 | N | 13 | 132 | N | 결제금액 - 수수료 |
| 14 | 실패사유 | AN | 40 | 145 | N | 실패 시 사유 텍스트 |
| 15 | Filler | AN | 65 | 185 | - | 공백 |

#### E 레코드 (End) — 1건

S레코드의 총건수, 총주문금액, 성공건수/금액, 실패건수/금액을 에코백하여 정합성 검증에 사용합니다.

#### 응답 파일 예시

> 파일명: ODRES_20260201_001.dat / 성공 2건, 실패 1건

```
[S] OD12 | 20260201 | 001 | PTN0001 | 건수:0000003 | 파일결과:0000 | 성공:0000002/205,000 | 실패:0000001/25,000
[D] 순번:0000001 | ORD-2026020100001 | PRD-A00001 | 85,000 | Y | 0000 | OH-20260201-00001 | 출고:20260203
[D] 순번:0000002 | ORD-2026020100002 | PRD-B00023 | 120,000 | Y | 0000 | OH-20260201-00002 | 출고:20260203
[D] 순번:0000003 | ORD-2026020100003 | PRD-C00105 | 25,000 | N | 8401 | 재고 부족 (현재고: 0)
[E] OD12 | 건수:0000003 | 성공:0000002/205,000 | 실패:0000001/25,000
```

---

## 4. 결과코드

> 응답 D레코드 처리결과(Y/N) + 결과코드(4자리) 조합

### 4.1 처리 결과코드

**성공**

| 결과 | 코드 | 설명 |
|:----:|:----:|------|
| Y | 0000 | 정상 접수 완료 |

**실패 — 주문 검증 오류**

| 결과 | 코드 | 설명 |
|:----:|:----:|------|
| N | 8201 | 주문요청일자 과거일 (수신일보다 이전) |
| N | 8202 | 주문번호 중복 (동일 파트너 내) |
| N | 8203 | 상품코드 미존재 |
| N | 8204 | 상품 판매 중지 |
| N | 8205 | 단가 불일치 (OrderHub 등록 단가와 상이) |
| N | 8206 | 금액 계산 오류 (수량 x 단가 ≠ 주문금액) |
| N | 8207 | 필수 필드 누락 또는 형식 오류 |

**실패 — 결제/재고 오류**

| 결과 | 코드 | 설명 |
|:----:|:----:|------|
| N | 8301 | 결제 한도 초과 |
| N | 8302 | 결제 수단 오류 |
| N | 8401 | 재고 부족 |
| N | 8402 | 출고 불가 지역 |

**실패 — 시스템 오류**

| 결과 | 코드 | 설명 |
|:----:|:----:|------|
| N | 9001 | 시스템 일시 오류 (재처리 요청) |
| N | 9002 | 처리 타임아웃 (재처리 요청) |
| N | 9999 | 기타 시스템 오류 |

> 참고: 9001, 9002는 일시적 오류이므로 재처리 가능합니다 (5.3절 참조).

### 4.2 파일 반려 코드

> 파일 수준 검증 실패 시 S레코드의 파일결과코드에 기록됩니다. 반려 시 D레코드 없이 S+E만 회신합니다.

| 코드 | 설명 |
|:----:|------|
| 0000 | 정상 수신 (건별 결과는 D레코드 참조) |
| 7001 | 파일 형식/레코드 길이 오류 |
| 7002 | S/E 레코드 건수 불일치 |
| 7003 | S/E 레코드 금액 불일치 |
| 7004 | D레코드 실제 건수 ≠ S레코드 총건수 |
| 7005 | 중복 파일 수신 (파일명+일자 기준) |
| 7006 | S/E 레코드 전문코드 오류 (OD11 아님) |
| 7007 | 미등록 파트너코드 |
| 7008 | 인코딩 오류 (UTF-8 아님) |

> 주의: 파일 반려 시 응답 파일에는 D레코드가 포함되지 않으며, S레코드와 E레코드의 건수/금액은 모두 0으로 설정됩니다.

---

## 5. 처리 요건

### 5.1 당일 처리 요건

| 항목 | 요건 |
|------|------|
| **대상** | D레코드 주문요청일자 = 파일 수신 당일 |
| **처리 방식** | 건별 실시간 주문 접수 + 결제 승인 |
| **응답 시점** | 당일건 전체 처리 완료 후 응답 파일 생성 |
| **운영 시간** | 08:00~22:00 (마감 후 수신 당일건은 익일 배치 전환) |
| **일 최대 건수** | 파트너당 10,000건/일 |

### 5.2 익일 처리 요건

| 항목 | 요건 |
|------|------|
| **대상** | D레코드 주문요청일자 > 파일 수신 당일 |
| **처리 방식** | 익영업일 배치 일괄 접수 |
| **배치 실행** | 매영업일 06:00 |
| **응답 시점** | 배치 처리 완료 후 당일 10:00 이내 응답 파일 생성 |
| **휴일/공휴일** | 미처리 → 다음 영업일 배치 |
| **예약 한도** | 수신일로부터 최대 30일 이내 |

### 5.3 재처리 규칙

| 항목 | 규칙 |
|------|------|
| **대상** | 시스템 오류(9001, 9002)로 실패한 건만 |
| **방법** | 실패 건만 추출하여 새 요청 파일로 재전송 |
| **주문번호** | 원본과 동일한 주문번호 사용 (중복 체크 면제) |
| **재전송 횟수** | 동일 주문번호 최대 3회 |
| **재전송 기한** | 원본 요청일로부터 3영업일 이내 |
| **비대상** | 8xxx 코드(검증 오류)는 재처리 불가 — 데이터 수정 후 신규 주문번호로 요청 |

> 주의: 재처리 시 원본과 동일한 주문번호를 사용해야 합니다. 새 주문번호로 전송하면 중복 주문이 발생할 수 있습니다.

---

## 6. 파일 검증 규칙

| No | 검증 항목 | 실패 시 처리 | 반려코드 |
|:--:|----------|-------------|:--------:|
| 1 | 파일명 패턴 일치 (ODREQ_YYYYMMDD_NNN.dat) | 전체 파일 반려 | 7001 |
| 2 | 파일 인코딩 UTF-8 확인 | 전체 파일 반려 | 7008 |
| 3 | S레코드 존재 및 전문코드 OD11 | 전체 파일 반려 | 7006 |
| 4 | E레코드 존재 | 전체 파일 반려 | 7001 |
| 5 | 레코드 길이 200byte 고정 | 전체 파일 반려 | 7001 |
| 6 | 파트너코드 등록 여부 | 전체 파일 반려 | 7007 |
| 7 | S/E 레코드 총건수 일치 | 전체 파일 반려 | 7002 |
| 8 | S/E 레코드 총금액 일치 | 전체 파일 반려 | 7003 |
| 9 | D레코드 실제 건수 = S레코드 총건수 | 전체 파일 반려 | 7004 |
| 10 | 동일 파일 중복 수신 | 전체 파일 반려 | 7005 |
| 11 | 주문번호 형식 (영문/숫자/하이픈, 20자 이내) | 건별 실패 | 8207 |
| 12 | 주문번호 중복 (동일 파트너 내, 재처리 제외) | 건별 실패 | 8202 |
| 13 | 상품코드 존재 및 판매 상태 확인 | 건별 실패 | 8203/8204 |
| 14 | 단가 일치 검증 | 건별 실패 | 8205 |
| 15 | 금액 계산 검증 (수량 x 단가 = 주문금액) | 건별 실패 | 8206 |
| 16 | 주문요청일자 유효성 (당일 이상만 허용) | 건별 실패 | 8201 |
| 17 | 필수 필드 검증 (수량, 결제금액, 수령인명 등) | 건별 실패 | 8207 |
| 18 | 재고 및 배송 가능 지역 확인 | 건별 실패 | 8401/8402 |

---

## 7. 연동 테스트 체크리스트

> 참고: 운영 전환 전 아래 항목을 모두 통과해야 합니다. 테스트 환경에서 수행합니다.

| No | 테스트 항목 | 검증 내용 | 상태 |
|:--:|------------|----------|:----:|
| 1 | SFTP 접속 | ID/PW 인증, 디렉토리 접근 권한 확인 | - |
| 2 | 파일 업로드 | 요청 파일 + .done 트리거 파일 정상 업로드 | - |
| 3 | 정상 주문 (당일) | 당일건 성공 응답 확인 | - |
| 4 | 정상 주문 (익일) | 익일건 배치 후 성공 응답 확인 | - |
| 5 | 혼합 파일 | 당일+익일 혼합, 각각 정상 처리 | - |
| 6 | 대량 파일 | 1,000건 이상, 처리 시간 및 정합성 | - |
| 7 | 상품코드 오류 | 결과코드 8203 확인 | - |
| 8 | 재고 부족 | 결과코드 8401 확인 | - |
| 9 | 중복 주문번호 | 결과코드 8202 확인 | - |
| 10 | 금액 불일치 | 결과코드 8206 확인 | - |
| 11 | 파일 반려 | 반려코드 7002/7005 확인 | - |
| 12 | 재처리 | 9001 실패 건 동일 주문번호로 재전송 성공 | - |
| 13 | 인코딩 검증 | 한글 수령인명/주소 정상 처리 | - |
